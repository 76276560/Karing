<script>
// 全局变量
let fileContent = '';
let targetUrl = '';
let base64Content = '';

// CORS代理列表
const corsProxies = [
    'https://api.allorigins.win/get?url=',
    'https://corsproxy.io/?',
    'https://proxy.cors.sh/',
    'https://nc-cors-anywhere.herokuapp.com/',
    'https://cors-anywhere.herokuapp.com/'
];

// 初始化日期
function initDate() {
    const now = new Date();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const todayDate = month + day;
    
    document.getElementById('currentDate').textContent = now.toLocaleDateString('zh-CN');
    document.getElementById('todayDate').textContent = todayDate;
}

// 文件选择处理
document.getElementById('fileInput').addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
    }
});

// 拖拽功能
const uploadArea = document.getElementById('uploadArea');

uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', function() {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) {
        handleFileSelect(e.dataTransfer.files[0]);
    }
});

// 处理文件选择
function handleFileSelect(file) {
    if (!file.name.endsWith('.txt')) {
        showStatus('请选择.txt文件', 'error');
        return;
    }
    
    // 显示文件信息
    document.getElementById('fileInfo').style.display = 'block';
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);
    
    const reader = new FileReader();
    reader.onload = function(e) {
        fileContent = e.target.result;
        targetUrl = extractUrl(fileContent);
        
        if (targetUrl) {
            showStatus(`找到链接: ${targetUrl}`, 'success');
            document.getElementById('processBtn').disabled = false;
        } else {
            showStatus('文件中未找到有效链接', 'error');
        }
    };
    
    reader.onerror = function() {
        showStatus('文件读取失败', 'error');
    };
    
    reader.readAsText(file);
}

// 提取URL
function extractUrl(content) {
    const urlMatch = content.match(/https?:\/\/[^\s\r\n]+/);
    return urlMatch ? urlMatch[0] : null;
}

// 使用多个代理尝试获取内容
async function fetchWithProxies(url) {
    for (let i = 0; i < corsProxies.length; i++) {
        try {
            const proxyUrl = corsProxies[i] + encodeURIComponent(url);
            console.log(`尝试代理 ${i + 1}: ${corsProxies[i]}`);
            
            const response = await fetch(proxyUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'text/plain',
                },
                timeout: 10000
            });
            
            if (response.ok) {
                const data = await response.text();
                
                // 处理不同的代理返回格式
                if (corsProxies[i].includes('allorigins.win')) {
                    const jsonData = JSON.parse(data);
                    return jsonData.contents;
                } else {
                    return data;
                }
            }
        } catch (error) {
            console.log(`代理 ${i + 1} 失败:`, error.message);
            continue;
        }
    }
    throw new Error('所有代理都失败了');
}

// 处理文件
async function processFile() {
    if (!targetUrl) {
        showStatus('请先选择包含链接的文件', 'error');
        return;
    }
    
    try {
        showStatus('正在获取链接内容...', 'info');
        document.getElementById('processBtn').disabled = true;
        
        // 获取链接内容
        base64Content = await fetchWithProxies(targetUrl);
        
        if (!base64Content) {
            throw new Error('未能获取到有效内容');
        }
        
        // 显示结果
        showResult(base64Content);
        showStatus('内容获取成功！', 'success');
        document.getElementById('downloadBtn').disabled = false;
        
    } catch (error) {
        showStatus(`获取失败: ${error.message}。请尝试手动获取。`, 'error');
        document.getElementById('processBtn').disabled = false;
        
        // 显示手动操作指引
        showManualInstructions();
    }
}

// 显示手动操作指引
function showManualInstructions() {
    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = `
        <h4>手动操作指引：</h4>
        <p>由于CORS限制，请按以下步骤手动操作：</p>
        <ol>
            <li>复制此链接：<strong>${targetUrl}</strong></li>
            <li>在新标签页中打开链接</li>
            <li>复制页面显示的Base64编码</li>
            <li>粘贴到下面的文本框中</li>
        </ol>
        <textarea id="manualInput" placeholder="在此处粘贴Base64编码..." style="width: 100%; height: 100px; margin: 10px 0; padding: 10px;"></textarea>
        <button class="btn" onclick="useManualInput()">使用手动输入</button>
    `;
    resultDiv.style.display = 'block';
}

// 使用手动输入的内容
function useManualInput() {
    const manualContent = document.getElementById('manualInput').value.trim();
    if (!manualContent) {
        showStatus('请输入Base64编码', 'error');
        return;
    }
    
    base64Content = manualContent;
    showResult(base64Content);
    showStatus('已使用手动输入的内容', 'success');
    document.getElementById('downloadBtn').disabled = false;
}

// 显示结果
function showResult(content) {
    const resultDiv = document.getElementById('result');
    resultDiv.textContent = content;
    resultDiv.style.display = 'block';
}

// 下载文件
function downloadFile() {
    if (!base64Content) {
        showStatus('没有可下载的内容', 'error');
        return;
    }
    
    const timestamp = new Date().toLocaleString('zh-CN');
    const today = new Date();
    const fileDate = String(today.getMonth() + 1).padStart(2, '0') + 
                   String(today.getDate()).padStart(2, '0');
    
    const finalContent = `# Karing 订阅数据
# 生成时间: ${timestamp}
# 文件日期: ${fileDate}
# 数据来源: ${targetUrl}

${base64Content}

# 文件结束`;
    
    const blob = new Blob([finalContent], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    
    a.href = url;
    a.download = '订阅.txt';
    a.click();
    
    URL.revokeObjectURL(url);
    showStatus('文件已下载完成，请上传到GitHub项目', 'success');
}

// 清空所有
function clearAll() {
    document.getElementById('fileInput').value = '';
    document.getElementById('fileInfo').style.display = 'none';
    document.getElementById('result').style.display = 'none';
    document.getElementById('processBtn').disabled = true;
    document.getElementById('downloadBtn').disabled = true;
    
    fileContent = '';
    targetUrl = '';
    base64Content = '';
    
    showStatus('已重置，请重新选择文件', 'info');
}

// 显示状态
function showStatus(message, type) {
    const statusDiv = document.getElementById('status');
    statusDiv.innerHTML = `<div class="status status-${type}">${message}</div>`;
}

// 格式化文件大小
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    initDate();
});
</script>